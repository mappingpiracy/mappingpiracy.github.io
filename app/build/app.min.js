var mp=angular.module("mp",["ngRoute","ui.bootstrap"]);mp.config(["$routeProvider",function(e){"use strict";e.when("/",{templateUrl:"app/components/map/map.view.html",controller:"MapController"}).when("/about",{templateUrl:"app/components/static/about.view.html",controller:"StaticController"}).when("/help",{templateUrl:"app/components/static/help.view.html",controller:"StaticController"}).otherwise({redirectTo:"/"})}]),function(){"use strict";function e(e,t,n,a){function r(){n.dataFilters={years:[],beginDate:new Date((new Date).getFullYear()-1,0,1),endDate:new Date((new Date).getFullYear(),11,31),selectedYear:null,countries:[],selectedClosestCoastalStates:[],selectedVesselCountries:[],territorialWaterStatuses:[],selectedTerritorialWaterStatuses:[],geolocationSources:[],selectedGeolocationSources:[],incidentTypes:[],selectedIncidentTypes:[],incidentActions:[],selectedIncidentActions:[]}}function s(){return{beginDate:n.dataFilters.beginDate,endDate:n.dataFilters.endDate,closestCoastalState:n.dataFilters.selectedClosestCoastalStates,territorialWaterStatus:n.dataFilters.selectedTerritorialWaterStatuses,geolocationSource:n.dataFilters.selectedGeolocationSources,vesselCountry:n.dataFilters.selectedVesselCountries,vesselStatus:n.dataFilters.selectedVesselStatuses,incidentType:n.dataFilters.selectedIncidentTypes,incidentAction:n.dataFilters.selectedIncidentActions}}function c(){e.getYears(n.dataSource.url).then(function(e){n.dataFilters.years=e,n.dataFilters.selectedYear=e[0],n.$watch(function(){return n.dataFilters.selectedYear},function(e){n.dataFilters.beginDate=new Date(e,0,1,0,0,0),n.dataFilters.endDate=new Date(e,11,31,0,0,0)})}),e.getCountries(n.dataSource.url).then(function(e){n.dataFilters.countries=e,n.dataFilters.selectedClosestCoastalStates=[]}),e.getTerritorialWaterStatuses(n.dataSource.url).then(function(e){n.dataFilters.territorialWaterStatuses=e,n.dataFilters.selectedTerritorialWaterStatuses=[]}),e.getIncidentTypes(n.dataSource.url).then(function(e){n.dataFilters.incidentTypes=e,n.dataFilters.selectedIncidentTypes=[]}),e.getIncidentActions(n.dataSource.url).then(function(e){n.dataFilters.incidentActions=e,n.dataFilters.selectedIncidentActions=[]}),e.getVesselStatuses(n.dataSource.url).then(function(e){n.dataFilters.vesselStatuses=e,n.dataFilters.selectedVesselStatuses=[]}),e.getGeolocationSources().then(function(e){n.dataFilters.geolocationSources=e,n.dataFilters.selectedGeolocationSources=[]})}function i(){n.createDataFilters(),n.populateDataFilters(),n.populateIncidents(),n.populateAnalysis()}function o(){var a=s(),r=t.open({template:"Loading Data"});e.getIncidents(n.dataSource.url,a,["*"]).then(function(e){n.map.data=e,r.close()})["catch"](function(e){r.close(),t.open({template:"An error occurred"})})}function u(){var t={beginDate:n.dataFilters.beginDate,endDate:n.dataFilters.endDate,closestCoastalState:n.dataFilters.selectedClosestCoastalStates};e.getIncidentsPerYearPerCountry(n.dataSource.url,t).then(function(e){n.analysis.data=e})}function l(){var t=s();e.exportIncidentsCSV(n.dataSource.url,t)}n.dataSource=null,n.dataSources=[],n.showFilters=!0,n.showAnalysis=!1,n.map={data:[]},n.analysis={data:[]},n.createDataFilters=r,n.populateDataFilters=c,n.resetDataFilters=i,n.populateIncidents=o,n.populateAnalysis=u,n.exportData=l,e.getDataSources().then(function(e){n.dataSource=e[0],n.dataSources=e,n.createDataFilters(),n.populateDataFilters(),n.populateIncidents(),n.populateAnalysis()})}mp.controller("MapController",["IncidentService","$modal","$scope","SheetRockService",e])}(),function(){"use strict";function e(e){e.foo="bar"}mp.controller("StaticController",["$scope",e])}(),function(){"use strict";function e(){function e(e,t){var n="mapping-piracy-export-"+(new Date).toString("yyyy-MM-dd-HH:mm:ss")+".csv",a=e.join(",")+"\n"+t.map(function(t){return e.map(function(e){return'"'+t[e]+'"'}).join()}).join("\n"),r=new Blob([a],{type:"text/csv; charset=utf-8;"});saveAs(r,n)}var t={exportCSV:e};return t}mp.service("ExportService",e),e.$inject=[]}(),function(){"use strict";function e(e,t,n,a,r){function s(e,t,n,a){var s=[];if(n=angular.isUndefined(n)?["*"]:n.join(", "),angular.isDefined(t.id)&&s.push("id = "+t.id),angular.isDefined(t.beginDate)&&angular.isDefined(t.endDate)&&(s.push('date "'+moment(t.beginDate).format("YYYY-MM-DD")+'" < date_occurred'),s.push('date "'+moment(t.endDate).format("YYYY-MM-DD")+'" > date_occurred')),angular.isDefined(t.closestCoastalState)&&t.closestCoastalState.length>0){var c=t.closestCoastalState.join("|");s.push('closest_coastal_state matches "'+c+'"')}if(angular.isDefined(t.territorialWaterStatus)&&t.territorialWaterStatus.length>0){var c=t.territorialWaterStatus.join("|");s.push('territorial_water_status matches "'+c+'"')}if(angular.isDefined(t.vesselCountry)&&t.vesselCountry.length>0){var c=t.vesselCountry.join("|");s.push('vessel_country matches "'+c+'"')}if(angular.isDefined(t.vesselStatus)&&t.vesselStatus.length>0){var c=t.vesselStatus.join("|");s.push('vessel_status matches "'+c+'"')}if(angular.isDefined(t.incidentType)&&t.incidentType.length>0){var c=t.incidentType.join("|");s.push('incident_type matches "'+c+'"')}if(angular.isDefined(t.incidentAction)&&t.incidentAction.length>0){var c=t.incidentAction.join("|");s.push('incident_action matches "'+c+'"')}if(angular.isDefined(t.geolocationSource)&&t.geolocationSource.length>0,s.length>0)var i="select "+n+" where "+s.join(" and ");return i=r.renderQuery(_.columnMap,i),r.executeQuery(e,i,a).then(function(e){return e=o(e)})["catch"](function(e){var t=[];return t})}function c(t,n){return s(t,n,["*"]).then(function(t){var n=Object.keys(_.columnMap);e.exportCSV(n,t)})}function i(e,t){var n,a=[],s=t.beginDate,c=t.endDate,i=t.closestCoastalState;return a.push('date "'+moment(s).format("YYYY-MM-DD")+'" < date_occurred'),a.push('date "'+moment(c).format("YYYY-MM-DD")+'" > date_occurred'),a.push("closest_coastal_state is not null"),angular.isDefined(i)&&i.length>0&&a.push('closest_coastal_state matches "'+i.join("|")+'"'),n="select count(id), year(date_occurred), closest_coastal_state where "+a.join(" and ")+' group by closest_coastal_state, year(date_occurred)  label count(id) "count", year(date_occurred) "year", closest_coastal_state "country"',n=r.renderQuery(_.columnMap,n),r.executeQuery(e,n).then(function(e){return e})}function o(e){return e.forEach(function(t,n){angular.isDefined(t.date_occurred)&&(t.date_occurred=r.convertDate(t.date_occurred)),(isNaN(t.latitude)||t.latitude<-90||t.latitude>90||isNaN(t.longitude)||t.longitude<-180||t.longitude>180)&&e.splice(n,1)}),e}function u(e){var t="select count(id), year(date_occurred) where date_occurred is not null group by year(date_occurred) order by year(date_occurred) desc";return t=r.renderQuery(_.columnMap,t),r.executeQuery(e,t).then(function(e){return e.map(function(e){return e["year(date_occurred)"]})})}function l(e){var t=[],n={},a="select closest_coastal_state, vessel_country where closest_coastal_state is not null and vessel_country is not null";return a=r.renderQuery(_.columnMap,a),r.executeQuery(e,a).then(function(e){return e.forEach(function(e){n[e.closest_coastal_state]=1,n[e.vessel_country]=1}),t=Object.keys(n).sort()})}function d(e){var t="select count(id), territorial_water_status where territorial_water_status is not null group by territorial_water_status order by territorial_water_status asc";return t=r.renderQuery(_.columnMap,t),r.executeQuery(e,t).then(function(e){return e.map(function(e){return e.territorial_water_status})})}function p(e){var t="select count(id), vessel_status where vessel_status is not null group by vessel_status order by vessel_status asc";return t=r.renderQuery(_.columnMap,t),r.executeQuery(e,t).then(function(e){return e.map(function(e){return e.vessel_status})})}function f(e){var t="select count(id), incident_type where incident_type is not null group by incident_type order by incident_type asc";return t=r.renderQuery(_.columnMap,t),r.executeQuery(e,t).then(function(e){return e.map(function(e){return e.incident_type})})}function m(e){var t="select count(id), incident_action where incident_action is not null group by incident_action order by incident_action asc";return t=r.renderQuery(_.columnMap,t),r.executeQuery(e,t).then(function(e){return e.map(function(e){return e.incident_action})})}function h(e){var t=a.defer();return t.resolve(["IMB","IMO","ASAM"]),t.promise}function y(){return t.get("config/data-sources.json").then(function(e){return _.dataSources=e.data,_.dataSources})}var _=this;_.columnMap={id:"A",date_occurred:"B",time_of_day:"C",time_of_day_recode:"D",incident_type:"E",incident_action:"F",territorial_water_status:"G",closest_coastal_state:"H",closest_coastal_state_cow_code:"I",latitude:"J",longitude:"K",location_precision:"L",geolocation_source_imb:"M",geolocation_source_imo:"N",geolocation_source_asam:"O",location_description:"P",vessel_name:"Q",vessel_country:"R",vessel_country_cow_code:"S",vessel_status:"T",violence_dummy:"U",steaming_recode:"V",incident_type_recode:"W",incident_action_recode:"X"};var v={getIncidents:s,exportIncidentsCSV:c,getIncidentsPerYearPerCountry:i,getYears:u,getCountries:l,getTerritorialWaterStatuses:d,getVesselStatuses:p,getIncidentTypes:f,getIncidentActions:m,getDataSources:y,getGeolocationSources:h};return v}mp.service("IncidentService",e),e.$inject=["ExportService","$http","$log","$q","SheetRockService"]}(),function(){"use strict";function e(e,t,n){function a(e,t,a){function r(e,n,a){if(e)console.error(t),console.error(e),console.error(a),s.reject(e);else{var r=a.rows.map(function(e){return e.cells});c(r[0])&&r.splice(0,1),s.resolve(r)}}var s=n.defer(),i={url:e,query:t,callback:r,reset:!0};return angular.isDefined(a)&&(i.fetchSize=a),sheetrock(i),s.promise}function r(e){return e=e.replace(/Date\(/g,""),e=e.replace(/\)/g,""),e=e.split(","),e=new Date(e[0],e[1],e[2],0,0,0),moment(e).format("YYYY-MM-DD")}function s(e,t){return Object.keys(e).forEach(function(n){var a=e[n],r=new RegExp("[(]"+n,"g");t=t.replace(r,"("+a),r=new RegExp("[ ]"+n,"g"),t=t.replace(r," "+a)}),t}function c(e){for(var t=Object.keys(e),n=0;n<t.length;n++)if(t[n]!==e[t[n]])return!1;return!0}var i=this;i.dataSources=[];var o={executeQuery:a,convertDate:r,renderQuery:s};return o}mp.service("SheetRockService",e),e.$inject=["$http","$log","$q"]}(),function(){"use strict";function e(){function e(e){function t(){var e=L.map("incident-map").setView([-10,50],3);return L.tileLayer("http://{s}.tiles.mapbox.com/v3/utkpiracyscience.n97d5l62/{z}/{x}/{y}.png",{maxZoom:14}).addTo(e),e.scrollWheelZoom.disable(),e}function n(e){var t='<div class="incident-popup"><ul>',n=[];return n.push(["ID",e.id]),n.push(["Date",e.date_occurred]),n.push(["Time",e.time_of_day]),n.push(["Incident Type",e.incident_type]),n.push(["Incident Action",e.incident_action]),n.push(["Longitude",e.longitude]),n.push(["Latitude",e.latitude]),n.push(["Closest Coastal State",e.closest_coastal_state]),n.push(["Territorial Water Status",e.territorial_water_status]),n.push(["Vessel Name",e.vessel_name]),n.push(["Vessel Country",e.vessel_country]),n.push(["Vessel Status",e.vessel_status]),n.forEach(function(e){t+="<li>"+e[0]+": "+e[1]+"</li>"}),t+="</ul></div>"}function a(e){var t,a;return t=e.map(function(e){return new L.marker([e.latitude,e.longitude]).on("click",function(t){this.bindPopup(n(e),{maxWidth:450}),this.openPopup()})}),a=L.layerGroup(t)}var r=t(),s=a(e.data);e.$watch(function(){return e.data},function(e){r.removeLayer(s),s=a(e),r.addLayer(s)})}return{restrict:"E",replace:!0,transclude:!0,templateUrl:"app/components/common/directives/incident-map/incident-map.template.html",scope:{data:"=data"},link:e}}mp.directive("incidentMap",[e])}(),function(){"use strict";function e(){return{restrict:"E",replace:!0,templateUrl:"app/components/common/directives/incidents-per-year/incidents-per-year.template.html",scope:{data:"=data",beginDate:"=beginDate",endDate:"=endDate",countries:"=countries"},link:function(e,t,n){function a(e){var t={},n=[],a=[];return e.forEach(function(e){t.hasOwnProperty(e.country)||(t[e.country]={key:e.country,values:[]}),t[e.country].values.push({year:e.year,count:Number(e.count)})}),Object.keys(t).forEach(function(e){n.push(t[e])}),a=n.sort(function(e,t){var n=0,a=0;return e.values.forEach(function(e){n+=e.count}),t.values.forEach(function(e){a+=e.count}),a>n?1:n>a?-1:0})}function r(t){for(var n,a=[],r=0,s=e.beginDate.getFullYear();s<=e.endDate.getFullYear();s++)a.push(s);t.forEach(function(e){e.values.forEach(function(e){(0===r||e.count>r)&&(r=e.count)})}),nv.addGraph(function(){return n=nv.models.lineChart().useInteractiveGuideline(!0),n.x(function(e){return e.year}),n.y(function(e){return e.count}),n.xAxis.axisLabel("Year"),n.forceX([a[0],a[a.length-1]]),n.xAxis.tickValues(a),n.yAxis.axisLabel("Incident Count"),n.forceY([0,r]),0===e.countries.length&&(t=t.splice(0,5)),d3.select(".incidents-per-year-graph > svg").datum(t).call(n),n})}e.$watch(function(){return e.data},function(e){var t=a(e);r(t)})}}}mp.directive("incidentsPerYear",e)}(),function(){"use strict";function e(){return{restrict:"E",replace:!0,templateUrl:"app/components/common/directives/typeahead-multiselect/typeahead-multiselect.template.html",scope:{enteredText:"=",allItems:"=",selectedItems:"="},link:function(e,t,n){e.selectItem=function(t){if(e.selectedItems.indexOf(t)<0){var n=e.allItems.indexOf(t);e.selectedItems.push(e.allItems[n])}e.enteredText=""},e.deselectItem=function(t){var n=e.selectedItems.indexOf(t);e.selectedItems.splice(n,1)}}}}mp.directive("typeaheadMultiselect",e)}();